name: Build Windows Binaries

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 autoconf automake libtool make g++ wget unzip pkg-config bison flex gettext autopoint upx-ucl \
                                libz-mingw-w64-dev libgcrypt-mingw-w64-dev libgpg-error-mingw-w64-dev

    - name: Build MinGW Dependencies
      shell: bash
      run: |
        set -e
        # Constants
        EXPAT_VER=2.6.2
        RE2_VER=2022-12-01
        LIBEWF_VER=20240506
        OPENSSL_VER=3.3.0
        AFFLIB_VER=3.7.20

        # URLs
        EXPAT_URL=https://github.com/libexpat/libexpat/releases/download/R_2_6_2/expat-${EXPAT_VER}.tar.bz2
        RE2_URL=https://github.com/google/re2/archive/refs/tags/${RE2_VER}.tar.gz
        LIBEWF_URL=https://github.com/libyal/libewf/releases/download/${LIBEWF_VER}/libewf-experimental-${LIBEWF_VER}.tar.gz
        OPENSSL_URL=https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VER}/openssl-${OPENSSL_VER}.tar.gz
        AFFLIB_URL=https://github.com/sshock/AFFLIBv3/archive/refs/tags/v${AFFLIB_VER}.tar.gz

        # Setup paths
        DEPS_ROOT=$(pwd)
        DEPS_WIN32=$DEPS_ROOT/deps_win32
        DEPS_WIN64=$DEPS_ROOT/deps_win64
        mkdir -p build_deps $DEPS_WIN32 $DEPS_WIN64
        cd build_deps

        # --- Functions ---
        build_expat() {
            local ARCH=$1; local PREFIX=$2; local HOST=$3
            echo "Building Expat for $ARCH..."
            if [ ! -f "expat-${EXPAT_VER}.tar.bz2" ]; then wget -q $EXPAT_URL; fi
            rm -rf expat-${EXPAT_VER}
            tar xf expat-${EXPAT_VER}.tar.bz2
            cd expat-${EXPAT_VER}
            ./configure --host=$HOST --prefix=$PREFIX --disable-shared --enable-static
            make -j$(nproc); make install
            cd ..
        }

        build_re2() {
            local ARCH=$1; local PREFIX=$2; local HOST=$3; local CMAKE_SYSTEM_PROCESSOR=$4
            echo "Building RE2 for $ARCH..."
            if [ ! -f "${RE2_VER}.tar.gz" ]; then wget -q $RE2_URL; fi
            rm -rf re2-${RE2_VER}
            tar xf ${RE2_VER}.tar.gz
            cd re2-${RE2_VER}
            mkdir build_$ARCH; cd build_$ARCH
            printf "set(CMAKE_SYSTEM_NAME Windows)\n" > toolchain.cmake
            printf "set(CMAKE_SYSTEM_PROCESSOR $CMAKE_SYSTEM_PROCESSOR)\n" >> toolchain.cmake
            printf "set(CMAKE_C_COMPILER $HOST-gcc)\n" >> toolchain.cmake
            printf "set(CMAKE_CXX_COMPILER $HOST-g++)\n" >> toolchain.cmake
            printf "set(CMAKE_RC_COMPILER $HOST-windres)\n" >> toolchain.cmake
            printf "set(CMAKE_FIND_ROOT_PATH $PREFIX)\n" >> toolchain.cmake
            printf "set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)\n" >> toolchain.cmake
            printf "set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)\n" >> toolchain.cmake
            printf "set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)\n" >> toolchain.cmake
            cmake .. -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake -DCMAKE_INSTALL_PREFIX=$PREFIX -DBUILD_SHARED_LIBS=OFF -DRE2_BUILD_TESTING=OFF
            make -j$(nproc); make install
            cd ../..
        }

        build_libewf() {
            local ARCH=$1; local PREFIX=$2; local HOST=$3
            echo "Building Libewf for $ARCH..."
            if [ ! -f "libewf-experimental-${LIBEWF_VER}.tar.gz" ]; then wget -q $LIBEWF_URL; fi
            rm -rf libewf-${LIBEWF_VER}
            tar xf libewf-experimental-${LIBEWF_VER}.tar.gz
            rm -rf libewf-${LIBEWF_VER}-$ARCH
            cp -r libewf-${LIBEWF_VER} libewf-${LIBEWF_VER}-$ARCH
            cd libewf-${LIBEWF_VER}-$ARCH
            autoreconf -fiv
            ./configure --host=$HOST --prefix=$PREFIX --disable-shared --enable-static --with-zlib --disable-python --disable-java --disable-openssl --with-libgcrypt=no --disable-nls
            make -j$(nproc); make install
            cd ..
        }

        build_openssl() {
            local ARCH=$1; local PREFIX=$2; local HOST=$3; local MINGW_TARGET=$4
            echo "Building OpenSSL for $ARCH..."
            if [ ! -f "openssl-${OPENSSL_VER}.tar.gz" ]; then wget -q $OPENSSL_URL; fi
            rm -rf openssl-${OPENSSL_VER}
            tar xf openssl-${OPENSSL_VER}.tar.gz
            rm -rf openssl-${OPENSSL_VER}-$ARCH
            cp -r openssl-${OPENSSL_VER} openssl-${OPENSSL_VER}-$ARCH
            cd openssl-${OPENSSL_VER}-$ARCH
            ./Configure $MINGW_TARGET --cross-compile-prefix=${HOST}- --prefix=$PREFIX --openssldir=$PREFIX/ssl --libdir=lib no-shared no-tests
            make -j$(nproc); make install_sw
            cd ..
        }

        build_afflib() {
            local ARCH=$1; local PREFIX=$2; local HOST=$3
            echo "Building AFFLIB for $ARCH..."
            if [ ! -f "v${AFFLIB_VER}.tar.gz" ]; then wget -q $AFFLIB_URL; fi
            rm -rf AFFLIBv3-${AFFLIB_VER}
            tar xf v${AFFLIB_VER}.tar.gz
            rm -rf AFFLIBv3-${AFFLIB_VER}-$ARCH
            cp -r AFFLIBv3-${AFFLIB_VER} AFFLIBv3-${AFFLIB_VER}-$ARCH
            cd AFFLIBv3-${AFFLIB_VER}-$ARCH
            # Patch LZMA cast issue on Win64
            sed -i 's/(unsigned int)Char/(size_t)Char/g' lzma443/C/Common/String.h
            sed -i 's/(unsigned int)Char/(size_t)Char/g' lzma443/C/Common/String.cpp
            sed -i 's/(unsigned int)res/(size_t)res/g' lzma443/C/Common/String.cpp
            autoreconf -fiv
            export CPPFLAGS="-I$PREFIX/include -D_WIN32_WINNT=0x0600 -DWINVER=0x0600"
            export LDFLAGS="-L$PREFIX/lib"
            export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig"
            export LIBS="-lws2_32 -lgdi32 -lcrypt32"
            ./configure --host=$HOST --prefix=$PREFIX --disable-shared --enable-static --enable-s3=no --enable-python=no --disable-fuse --disable-qemu
            make -j$(nproc); make install
            cd ..
        }

        # Execution
        build_expat "win32" "$DEPS_WIN32" "i686-w64-mingw32"
        build_expat "win64" "$DEPS_WIN64" "x86_64-w64-mingw32"

        build_re2 "win32" "$DEPS_WIN32" "i686-w64-mingw32" "x86"
        build_re2 "win64" "$DEPS_WIN64" "x86_64-w64-mingw32" "AMD64"

        build_libewf "win32" "$DEPS_WIN32" "i686-w64-mingw32"
        build_libewf "win64" "$DEPS_WIN64" "x86_64-w64-mingw32"

        build_openssl "win32" "$DEPS_WIN32" "i686-w64-mingw32" "mingw"
        build_openssl "win64" "$DEPS_WIN64" "x86_64-w64-mingw32" "mingw64"

        build_afflib "win32" "$DEPS_WIN32" "i686-w64-mingw32"
        build_afflib "win64" "$DEPS_WIN64" "x86_64-w64-mingw32"

    - name: Bootstrap
      run: |
        ./bootstrap.sh

    - name: Build Bulk Extractor Win32
      shell: bash
      run: |
        set -e
        if [ -f Makefile ]; then make distclean; fi
        DEPS=$(pwd)/deps_win32
        HOST=i686-w64-mingw32
        export CPPFLAGS="-I$DEPS/include -D_WIN32_WINNT=0x0600 -DWINVER=0x0600"
        export LDFLAGS="-L$DEPS/lib -static-libgcc -static-libstdc++"
        export PKG_CONFIG_PATH="$DEPS/lib/pkgconfig"

        ./configure --host=$HOST --with-libexpat=$DEPS --with-zlib --enable-static --disable-shared
        make -j$(nproc)

        mkdir -p bin/win32
        cp src/bulk_extractor.exe bin/win32/

    - name: Build Bulk Extractor Win64
      shell: bash
      run: |
        set -e
        if [ -f Makefile ]; then make distclean; fi
        DEPS=$(pwd)/deps_win64
        HOST=x86_64-w64-mingw32
        export CPPFLAGS="-I$DEPS/include -D_WIN32_WINNT=0x0600 -DWINVER=0x0600"
        export LDFLAGS="-L$DEPS/lib -static-libgcc -static-libstdc++"
        export PKG_CONFIG_PATH="$DEPS/lib/pkgconfig"

        ./configure --host=$HOST --with-libexpat=$DEPS --with-zlib --enable-static --disable-shared
        make -j$(nproc)

        mkdir -p bin/win64
        cp src/bulk_extractor.exe bin/win64/

    - name: Compress Binaries
      run: |
        if command -v upx >/dev/null 2>&1; then
          upx --best bin/win32/bulk_extractor.exe
          upx --best bin/win64/bulk_extractor.exe
        elif command -v upx-ucl >/dev/null 2>&1; then
          upx-ucl --best bin/win32/bulk_extractor.exe
          upx-ucl --best bin/win64/bulk_extractor.exe
        fi

    - name: Upload Win32 Artifact
      uses: actions/upload-artifact@v4
      with:
        name: bulk_extractor_win32
        path: bin/win32/bulk_extractor.exe

    - name: Upload Win64 Artifact
      uses: actions/upload-artifact@v4
      with:
        name: bulk_extractor_win64
        path: bin/win64/bulk_extractor.exe
